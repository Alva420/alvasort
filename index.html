<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšå®¶å¤§é™¢æ’åºçŒœæµ‹æ¸¸æˆ</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- é…ç½®Tailwindè‡ªå®šä¹‰é¢œè‰²å’Œå­—ä½“ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        accent: '#ec4899',
                        neutral: '#1f2937',
                        'neutral-light': '#f3f4f6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- è‡ªå®šä¹‰å·¥å…·ç±» -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .color-item {
                @apply w-14 h-14 md:w-16 md:h-16 rounded-full flex items-center justify-center text-2xl md:text-3xl cursor-pointer transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105;
            }
            .color-item.selected {
                @apply ring-4 ring-accent scale-110;
            }
            .color-img {
                @apply w-full h-full object-cover rounded-full;
            }
            .color-container {
                @apply flex gap-2 md:gap-3 flex-wrap justify-center p-4 bg-white/50 backdrop-blur-sm rounded-xl shadow-lg;
            }
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-full transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-primary/50;
            }
            .game-card {
                @apply bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl shadow-xl p-6 md:p-8 transition-all duration-500 hover:shadow-2xl;
            }
            .auth-input {
                @apply w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all outline-none;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 font-sans text-neutral flex flex-col items-center justify-start pt-8 pb-16 px-4">
    <!-- é€‰ä¸­æç¤º -->
    <div id="selected-indicator" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-accent text-white px-4 py-2 rounded-full shadow-lg z-40">
        <span>å·²é€‰ä¸­: </span>
        <span id="selected-name" class="font-bold"></span>
    </div>

    <!-- ç”¨æˆ·è®¤è¯æ¨¡æ€æ¡† -->
    <div id="auth-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">éšå®¶å¤§é™¢æ’åºå¤§å¸ˆ</h2>
                <p class="text-gray-600">è¯·ç™»å½•æˆ–æ³¨å†Œè´¦å·</p>
            </div>
            
            <!-- åˆ‡æ¢è¡¨å•æŒ‰é’® -->
            <div class="flex mb-6">
                <button id="login-tab" class="flex-1 py-2 font-medium text-primary border-b-2 border-primary">ç™»å½•</button>
                <button id="register-tab" class="flex-1 py-2 font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700">æ³¨å†Œ</button>
            </div>
            
            <!-- ç™»å½•è¡¨å• -->
            <div id="login-form" class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-1" for="login-username">ç”¨æˆ·å</label>
                    <input type="text" id="login-username" class="auth-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1" for="login-password">å¯†ç </label>
                    <input type="password" id="login-password" class="auth-input" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button id="login-btn" class="btn-primary w-full">
                    <i class="fa fa-sign-in mr-2"></i>ç™»å½•
                </button>
                <p id="login-error" class="text-red-500 text-center hidden"></p>
            </div>
            
            <!-- æ³¨å†Œè¡¨å• (é»˜è®¤éšè—) -->
            <div id="register-form" class="space-y-4 hidden">
                <div>
                    <label class="block text-gray-700 mb-1" for="reg-username">ç”¨æˆ·å</label>
                    <input type="text" id="reg-username" class="auth-input" placeholder="è¯·åˆ›å»ºç”¨æˆ·å">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1" for="reg-password">å¯†ç </label>
                    <input type="password" id="reg-password" class="auth-input" placeholder="è¯·åˆ›å»ºå¯†ç ">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1" for="reg-confirm">ç¡®è®¤å¯†ç </label>
                    <input type="password" id="reg-confirm" class="auth-input" placeholder="è¯·ç¡®è®¤å¯†ç ">
                </div>
                <button id="register-btn" class="btn-primary w-full">
                    <i class="fa fa-user-plus mr-2"></i>æ³¨å†Œ
                </button>
                <p id="register-error" class="text-red-500 text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- æ¨¡å¼é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="mode-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">é€‰æ‹©æ¸¸æˆæ¨¡å¼</h2>
                <p class="text-gray-600">æ¬¢è¿å›æ¥ï¼Œ<span id="welcome-username" class="font-semibold text-primary"></span>ï¼</p>
            </div>
            
            <div class="space-y-4">
                <!-- ç®€å•æ¨¡å¼ -->
                <div class="border border-gray-200 rounded-xl p-5 hover:border-primary cursor-pointer transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg" id="easy-mode">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ç®€å•æ¨¡å¼</h3>
                    <p class="text-gray-600 mb-3">7ä¸ªå›¾åƒæ’åº</p>
                </div>
                
                <!-- å›°éš¾æ¨¡å¼ -->
                <div class="border border-gray-200 rounded-xl p-5 hover:border-primary cursor-pointer transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg" id="hard-mode">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">å›°éš¾æ¨¡å¼</h3>
                    <p class="text-gray-600 mb-3">10ä¸ªå›¾åƒæ’åº</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å¥–åŠ±å›¾ç‰‡æ¨¡æ€æ¡† -->
    <div id="reward-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">æ­å–œè·å¾—å¥–åŠ±ï¼</h2>
            <div class="mb-6 flex justify-center">
                <img id="reward-image" src="" alt="å¥–åŠ±å›¾ç‰‡" class="max-h-64 rounded-lg shadow-lg">
            </div>
            <p id="reward-message" class="text-gray-600 mb-6"></p>
            <button id="close-reward" class="btn-primary">
                <i class="fa fa-refresh mr-2"></i>å†ç©ä¸€æ¬¡
            </button>
        </div>
    </div>

    <!-- æ¸¸æˆå®¹å™¨ -->
    <div class="max-w-3xl w-full hidden" id="game-container">
        <!-- å½“å‰ç”¨æˆ·ä¿¡æ¯ -->
        <div class="flex justify-end items-center mb-4">
            <div class="bg-white px-4 py-2 rounded-full shadow flex items-center gap-2">
                <i class="fa fa-user text-primary"></i>
                <span id="current-user" class="font-medium"></span>
                <button id="logout-btn" class="text-gray-500 hover:text-red-500 transition-colors">
                    <i class="fa fa-sign-out"></i>
                </button>
            </div>
        </div>
        
        <!-- æ¸¸æˆæ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary mb-2">éšå®¶å¤§é™¢æ’åºå¤§å¸ˆ</h1>
            <p class="text-gray-600 text-lg" id="mode-display">ç®€å•æ¨¡å¼ - 7ä¸ªå›¾åƒæ’åº</p>
        </div>
        
        <!-- æ¸¸æˆå¡ç‰‡ -->
        <div class="game-card mb-8">
            <!-- æ¸¸æˆä¿¡æ¯åŒº -->
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-white px-4 py-2 rounded-full shadow flex items-center gap-2">
                        <i class="fa fa-refresh text-primary"></i>
                        <span id="attempts" class="font-bold">çŒœæµ‹æ¬¡æ•°: 0</span>
                    </div>
                    <div class="bg-white px-4 py-2 rounded-full shadow flex items-center gap-2">
                        <i class="fa fa-check-circle text-accent"></i>
                        <span id="correct-count" class="font-bold">æ­£ç¡®æ•°é‡: 0</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="change-mode-btn" class="flex items-center gap-2 bg-secondary hover:bg-secondary/90 text-white px-4 py-2 rounded-full transition-all duration-300">
                        <i class="fa fa-exchange"></i>
                        <span>æ›´æ¢æ¨¡å¼</span>
                    </button>
                    <button id="restart-btn" class="flex items-center gap-2 bg-neutral hover:bg-neutral/90 text-white px-4 py-2 rounded-full transition-all duration-300">
                        <i class="fa fa-gamepad"></i>
                        <span>é‡æ–°å¼€å§‹</span>
                    </button>
                </div>
            </div>
            
            <!-- ç›®æ ‡åºåˆ—åŒºåŸŸ (åˆå§‹éšè—) -->
            <div id="target-container" class="hidden mb-8">
                <h2 class="text-xl font-semibold mb-3 text-center text-gray-700">ç›®æ ‡åºåˆ—</h2>
                <div id="target-sequence" class="color-container"></div>
            </div>
            
            <!-- ç©å®¶æ’åºåŒºåŸŸ -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-3 text-center text-gray-700">è¯·æ’åºä½ çš„çŒœæµ‹</h2>
                <div id="guess-container" class="color-container min-h-[100px]">
                    <!-- å›¾ç‰‡é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- æäº¤æŒ‰é’® -->
            <div class="text-center">
                <button id="submit-btn" class="btn-primary">
                    <i class="fa fa-paper-plane mr-2"></i>æäº¤çŒœæµ‹
                </button>
            </div>
        </div>
        
        <!-- æ¸¸æˆè¯´æ˜ -->
        <div class="bg-white rounded-xl shadow-md p-5 mb-8">
            <h3 class="text-lg font-semibold mb-2 text-gray-800 flex items-center">
                <i class="fa fa-info-circle text-primary mr-2"></i>æ¸¸æˆè¯´æ˜
            </h3>
            <ul class="list-disc pl-5 text-gray-600 space-y-1">
                <li>å›¾ç‰‡èµ„æºæ¥æºäºç½‘æ˜“ç¬¬äº”äººæ ¼ï¼Œæœ¬ç¨‹åºä»…ä¾›å¨±ä¹ä¸åšå•†ç”¨</li>
                <li>ç‚¹å‡»ç¬¬ä¸€å¼ å›¾ç‰‡ï¼Œå†ç‚¹å‡»ç¬¬äºŒå¼ å›¾ç‰‡è¿›è¡Œäº¤æ¢</li>
                <li>æ¯æ¬¡æäº¤åï¼Œä¼šæ˜¾ç¤ºä½ çŒœå¯¹ä½ç½®çš„å›¾ç‰‡æ•°é‡</li>
                <li>ç›®æ ‡æ˜¯æ‰¾å‡ºæ­£ç¡®çš„å›¾ç‰‡æ’åˆ—é¡ºåº</li>
                <li>å°è¯•ç”¨æœ€å°‘çš„æ¬¡æ•°å®ŒæˆæŒ‘æˆ˜ï¼</li>
            </ul>
        </div>
        
        <!-- ç©å®¶è®°å½•å’Œå†å² -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- ç©å®¶è®°å½• -->
            <div class="bg-white rounded-xl shadow-md p-5">
                <h3 class="text-lg font-semibold mb-3 text-gray-800 flex items-center">
                    <i class="fa fa-trophy text-primary mr-2"></i>æˆ‘çš„è®°å½•
                </h3>
                <div id="player-stats" class="space-y-3">
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="font-medium">ç®€å•æ¨¡å¼æœ€ä½³ï¼š<span id="easy-best" class="text-green-600">-</span></p>
                        <p class="text-sm text-gray-500">ä¸Šæ¬¡ï¼š<span id="easy-last">-</span></p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="font-medium">å›°éš¾æ¨¡å¼æœ€ä½³ï¼š<span id="hard-best" class="text-green-600">-</span></p>
                        <p class="text-sm text-gray-500">ä¸Šæ¬¡ï¼š<span id="hard-last">-</span></p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="font-medium">æ€»æ¸¸æˆæ¬¡æ•°ï¼š<span id="total-games">0</span></p>
                    </div>
                </div>
            </div>
            
            <!-- å†å²è®°å½• -->
            <div class="bg-white rounded-xl shadow-md p-5">
                <h3 class="text-lg font-semibold mb-3 text-gray-800 flex items-center">
                    <i class="fa fa-history text-primary mr-2"></i>æœ€è¿‘è®°å½•
                </h3>
                <div id="history-container" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                    <p class="text-gray-500 text-center italic">æš‚æ— æ¸¸æˆè®°å½•</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- èƒœåˆ©å¼¹çª— (ç°åœ¨ä»…ä½œä¸ºè¿‡æ¸¡ï¼Œä¼šè‡ªåŠ¨è½¬ä¸ºå¥–åŠ±å¼¹çª—) -->
    <div id="win-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-500 scale-95 opacity-0" id="modal-content">
            <div class="text-center">
                <div class="text-5xl mb-4">ğŸ‰</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">æ­å–œä½ èµ¢äº†ï¼</h2>
                <p class="text-gray-600 mb-6">ä½ ç”¨äº† <span id="final-attempts" class="font-bold text-primary">0</span> æ¬¡çŒœå‡ºäº†æ­£ç¡®åºåˆ—</p>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆé…ç½®å’ŒçŠ¶æ€
        const gameState = {
            currentUser: null,
            mode: null, // 'easy' æˆ– 'hard'
            targetSequence: [],
            guessSequence: [],
            selectedItem: null,
            attempts: 0,
            correctCount: 0,
            history: [],
            isProcessing: false, // æ·»åŠ å¤„ç†çŠ¶æ€æ ‡å¿—ï¼Œé˜²æ­¢å¿«é€Ÿç‚¹å‡»
            images: {
                
                easy: [
                    { id: 'bj', name: 'è–„é‡‘', src: 'images/bj.png' },
                    { id: 'dyz', name: 'å…¸ç‹±é•¿', src: 'images/dyz.png' },
                    { id: 'sxgw', name: 'é¦–å¸­é¡¾é—®', src: 'images/sxgw.png' },
                    { id: 'sxl', name: 'å‡å­¦ç¤¼', src: 'images/sxl.png' },
                    { id: 'xcms', name: 'ä¹¡æ‘ç‰§å¸ˆ', src: 'images/xcms.png' },
                    { id: 'ys', name: 'æ¸¸éš¼', src: 'images/ys.png' },
                    { id: 'hermit', name: 'éšå£«', src: 'images/hermit.png' }
                ],
                // å›°éš¾æ¨¡å¼å›¾ç‰‡
                hard: [
                    { id: 'txdt', name: 'åŠ¨æ€å¤´åƒ', src: 'images/txdt.png' },
                    { id: 'txdyz', name: 'å…¸ç‹±é•¿', src: 'images/txdyz.jpg' },
                    { id: 'txys', name: 'æ¸¸éš¼', src: 'images/txys.jpg' },
                    { id: 'txds', name: 'å¤§æš‘å¤´åƒ', src: 'images/txds.jpg' },
                    { id: 'txhb', name: 'é»‘ç™½å¤´åƒ', src: 'images/txhb.png' },
                    { id: 'txbj', name: 'è–„é‡‘', src: 'images/txbj.jpg' },
                    { id: 'txbjq', name: 'è–„é‡‘Qç‰ˆ', src: 'images/txbjq.jpg' },
                    { id: 'txcshy', name: 'å½©è‰²å›å¿†', src: 'images/txcshy.png' },
                    { id: 'txlym', name: 'å¦ä¸€é¢', src: 'images/txlym.png' },
                    { id: 'txsxgw', name: 'é¦–å¸­é¡¾é—®', src: 'images/txsxgw.png' }
                ],
                // å¥–åŠ±å›¾ç‰‡
                rewards: {
                    jl: 'images/jl.png',
                    jl1: 'images/jl1.png',
                    jl2: 'images/jl2.png',
                    jl3: 'images/jl3.jpg'
                }
            }
        };

        // DOMå…ƒç´ 
        const elements = {
            // è®¤è¯ç›¸å…³
            authModal: document.getElementById('auth-modal'),
            loginTab: document.getElementById('login-tab'),
            registerTab: document.getElementById('register-tab'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            loginBtn: document.getElementById('login-btn'),
            registerBtn: document.getElementById('register-btn'),
            loginUsername: document.getElementById('login-username'),
            loginPassword: document.getElementById('login-password'),
            regUsername: document.getElementById('reg-username'),
            regPassword: document.getElementById('reg-password'),
            regConfirm: document.getElementById('reg-confirm'),
            loginError: document.getElementById('login-error'),
            registerError: document.getElementById('register-error'),
            
            // æ¨¡å¼é€‰æ‹©
            modeModal: document.getElementById('mode-modal'),
            welcomeUsername: document.getElementById('welcome-username'),
            easyMode: document.getElementById('easy-mode'),
            hardMode: document.getElementById('hard-mode'),
            
            // æ¸¸æˆå®¹å™¨
            gameContainer: document.getElementById('game-container'),
            currentUser: document.getElementById('current-user'),
            modeDisplay: document.getElementById('mode-display'),
            logoutBtn: document.getElementById('logout-btn'),
            changeModeBtn: document.getElementById('change-mode-btn'),
            
            // æ¸¸æˆå…ƒç´ 
            attempts: document.getElementById('attempts'),
            correctCount: document.getElementById('correct-count'),
            restartBtn: document.getElementById('restart-btn'),
            submitBtn: document.getElementById('submit-btn'),
            targetContainer: document.getElementById('target-container'),
            targetSequence: document.getElementById('target-sequence'),
            guessContainer: document.getElementById('guess-container'),
            selectedIndicator: document.getElementById('selected-indicator'),
            selectedName: document.getElementById('selected-name'),
            historyContainer: document.getElementById('history-container'),
            
            // ç©å®¶è®°å½•
            easyBest: document.getElementById('easy-best'),
            easyLast: document.getElementById('easy-last'),
            hardBest: document.getElementById('hard-best'),
            hardLast: document.getElementById('hard-last'),
            totalGames: document.getElementById('total-games'),
            
            // èƒœåˆ©å¼¹çª—
            winModal: document.getElementById('win-modal'),
            modalContent: document.getElementById('modal-content'),
            finalAttempts: document.getElementById('final-attempts'),
            
            // å¥–åŠ±å¼¹çª—
            rewardModal: document.getElementById('reward-modal'),
            rewardImage: document.getElementById('reward-image'),
            rewardMessage: document.getElementById('reward-message'),
            closeReward: document.getElementById('close-reward')
        };

        // ç©å®¶æ•°æ®åº“ (ä½¿ç”¨localStorage)
        const playerDB = {
            // åˆå§‹åŒ–æ•°æ®åº“
            init() {
                if (!localStorage.getItem('players')) {
                    localStorage.setItem('players', JSON.stringify({}));
                }
            },
            
            // æ³¨å†Œæ–°ç”¨æˆ·
            register(username, password) {
                const players = JSON.parse(localStorage.getItem('players'));
                
                if (players[username]) {
                    return { success: false, message: 'ç”¨æˆ·åå·²å­˜åœ¨' };
                }
                
                // åˆ›å»ºæ–°ç”¨æˆ·
                players[username] = {
                    password,
                    stats: {
                        easy: { best: null, last: null },
                        hard: { best: null, last: null },
                        totalGames: 0
                    },
                    history: []
                };
                
                localStorage.setItem('players', JSON.stringify(players));
                return { success: true };
            },
            
            // ç”¨æˆ·ç™»å½•
            login(username, password) {
                const players = JSON.parse(localStorage.getItem('players'));
                const user = players[username];
                
                if (!user || user.password !== password) {
                    return { success: false, message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' };
                }
                
                return { success: true, user };
            },
            
            // æ›´æ–°ç©å®¶ç»Ÿè®¡
            updateStats(username, mode, attempts) {
                const players = JSON.parse(localStorage.getItem('players'));
                const user = players[username];
                
                if (!user) return;
                
                // æ›´æ–°æ€»æ¸¸æˆæ¬¡æ•°
                user.stats.totalGames++;
                
                // æ›´æ–°æ¨¡å¼ç‰¹å®šç»Ÿè®¡
                if (!user.stats[mode].best || attempts < user.stats[mode].best) {
                    user.stats[mode].best = attempts;
                }
                user.stats[mode].last = attempts;
                
                // è®°å½•å†å²
                const now = new Date();
                const dateStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes()}`;
                user.history.unshift({
                    mode,
                    attempts,
                    date: dateStr
                });
                
                // é™åˆ¶å†å²è®°å½•æ•°é‡
                if (user.history.length > 10) {
                    user.history = user.history.slice(0, 10);
                }
                
                localStorage.setItem('players', JSON.stringify(players));
                return user;
            },
            
            // è·å–ç©å®¶æ•°æ®
            getPlayer(username) {
                const players = JSON.parse(localStorage.getItem('players'));
                return players[username];
            }
        };

        // å·¥å…·å‡½æ•°
        const utils = {
            // æ‰“ä¹±æ•°ç»„é¡ºåº
            shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            },
            
            // æ£€æŸ¥ä¸¤ä¸ªæ•°ç»„æ˜¯å¦ç›¸ç­‰
            arraysEqual(arr1, arr2) {
                if (arr1.length !== arr2.length) return false;
                return arr1.every((item, index) => item.id === arr2[index].id);
            },
            
            // è®¡ç®—æ­£ç¡®ä½ç½®çš„æ•°é‡
            countCorrectPositions(arr1, arr2) {
                let count = 0;
                for (let i = 0; i < arr1.length; i++) {
                    if (arr1[i].id === arr2[i].id) {
                        count++;
                    }
                }
                return count;
            },
            
            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            showError(element, message) {
                element.textContent = message;
                element.classList.remove('hidden');
                
                setTimeout(() => {
                    element.classList.add('hidden');
                }, 3000);
            },
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†åŠ¨ç”»
            showModal(modal, content) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    if (content) {
                        content.classList.remove('scale-95', 'opacity-0');
                        content.classList.add('scale-100', 'opacity-100');
                    }
                }, 10);
            },
            
            // éšè—æ¨¡æ€æ¡†åŠ¨ç”»
            hideModal(modal, content) {
                if (content) {
                    content.classList.remove('scale-100', 'opacity-100');
                    content.classList.add('scale-95', 'opacity-0');
                }
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        };

        // æ¸¸æˆå‡½æ•°
        const game = {
            // åˆå§‹åŒ–æ¸¸æˆ
            init(mode) {
                gameState.mode = mode;
                gameState.attempts = 0;
                gameState.correctCount = 0;
                gameState.selectedItem = null;
                gameState.isProcessing = false; // é‡ç½®å¤„ç†çŠ¶æ€
                
                // æ ¹æ®æ¨¡å¼è®¾ç½®åºåˆ—
                if (mode === 'easy') {
                    gameState.targetSequence = [...gameState.images.easy];
                    elements.modeDisplay.textContent = 'ç®€å•æ¨¡å¼ - 7ä¸ªå›¾åƒæ’åº';
                } else {
                    gameState.targetSequence = [...gameState.images.hard];
                    elements.modeDisplay.textContent = 'å›°éš¾æ¨¡å¼ - 10ä¸ªå›¾åƒæ’åº';
                }
                
                // æ‰“ä¹±åºåˆ—ä½œä¸ºç©å®¶åˆå§‹åºåˆ—
                gameState.guessSequence = utils.shuffleArray(gameState.targetSequence);
                
                // æ›´æ–°UI
                game.updateUI();
                game.renderGuessSequence();
                game.updatePlayerStats();
            },
            
            // æ›´æ–°æ¸¸æˆUI
            updateUI() {
                elements.attempts.textContent = `çŒœæµ‹æ¬¡æ•°: ${gameState.attempts}`;
                elements.correctCount.textContent = `æ­£ç¡®æ•°é‡: ${gameState.correctCount}`;
                elements.targetContainer.classList.add('hidden');
            },
            
            // æ¸²æŸ“ç©å®¶çŒœæµ‹åºåˆ—
            renderGuessSequence() {
                elements.guessContainer.innerHTML = '';
                
                gameState.guessSequence.forEach((item, index) => {
                    const element = document.createElement('div');
                    element.className = 'color-item';
                    element.dataset.index = index;
                    
                    const img = document.createElement('img');
                    img.src = item.src;
                    img.alt = item.name;
                    img.className = 'color-img';
                    
                    element.appendChild(img);
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç”¨äºé€‰æ‹©å’Œäº¤æ¢
                    element.addEventListener('click', () => game.handleItemClick(index));
                    
                    elements.guessContainer.appendChild(element);
                });
            },
            
            // å¤„ç†å›¾ç‰‡é¡¹ç‚¹å‡» - ä¿®å¤ç‰ˆæœ¬
            handleItemClick(index) {
                // é˜²æ­¢å¿«é€Ÿè¿ç»­ç‚¹å‡»å¯¼è‡´çš„çŠ¶æ€æ··ä¹±
                if (gameState.isProcessing) return;
                gameState.isProcessing = true;
                
                try {
                    const items = elements.guessContainer.getElementsByClassName('color-item');
                    
                    // å¦‚æœæ²¡æœ‰é€‰ä¸­é¡¹ï¼Œé€‰ä¸­å½“å‰é¡¹
                    if (gameState.selectedItem === null) {
                        gameState.selectedItem = index;
                        items[index].classList.add('selected');
                        
                        // æ˜¾ç¤ºé€‰ä¸­æç¤º
                        elements.selectedName.textContent = gameState.guessSequence[index].name;
                        elements.selectedIndicator.classList.remove('hidden');
                    } 
                    // å¦‚æœç‚¹å‡»çš„æ˜¯å·²é€‰ä¸­é¡¹ï¼Œå–æ¶ˆé€‰ä¸­
                    else if (gameState.selectedItem === index) {
                        gameState.selectedItem = null;
                        items[index].classList.remove('selected');
                        elements.selectedIndicator.classList.add('hidden');
                    } 
                    // äº¤æ¢ä¸¤ä¸ªé€‰ä¸­é¡¹
                    else {
                        // ç§»é™¤ä¹‹å‰é€‰ä¸­é¡¹çš„æ ·å¼
                        items[gameState.selectedItem].classList.remove('selected');
                        
                        // äº¤æ¢å…ƒç´ 
                        [gameState.guessSequence[gameState.selectedItem], gameState.guessSequence[index]] = 
                        [gameState.guessSequence[index], gameState.guessSequence[gameState.selectedItem]];
                        
                        // é‡æ–°æ¸²æŸ“
                        game.renderGuessSequence();
                        
                        // é‡ç½®é€‰ä¸­çŠ¶æ€å’Œæç¤º
                        gameState.selectedItem = null;
                        elements.selectedIndicator.classList.add('hidden');
                    }
                } finally {
                    // æ— è®ºå¦‚ä½•éƒ½é‡ç½®å¤„ç†çŠ¶æ€
                    setTimeout(() => {
                        gameState.isProcessing = false;
                    }, 100); // çŸ­æš‚å»¶è¿Ÿç¡®ä¿æ¸²æŸ“å®Œæˆ
                }
            },
            
            // æäº¤çŒœæµ‹
            submitGuess() {
                gameState.attempts++;
                
                // è®¡ç®—æ­£ç¡®æ•°é‡
                gameState.correctCount = utils.countCorrectPositions(
                    gameState.targetSequence, 
                    gameState.guessSequence
                );
                
                // æ›´æ–°UI
                game.updateUI();
                
                // æ·»åŠ åˆ°å†å²è®°å½•
                game.addToHistory();
                
                // æ£€æŸ¥æ˜¯å¦çŒœå¯¹
                if (utils.arraysEqual(gameState.targetSequence, gameState.guessSequence)) {
                    game.handleWin();
                }
            },
            
            // å¤„ç†èƒœåˆ© - ä¿®æ”¹ä¸ºç›´æ¥æ˜¾ç¤ºå¥–åŠ±
            handleWin() {
                // æ˜¾ç¤ºç›®æ ‡åºåˆ—
                elements.targetContainer.classList.remove('hidden');
                game.renderTargetSequence();
                
                // æ›´æ–°ç©å®¶ç»Ÿè®¡
                const updatedUser = playerDB.updateStats(
                    gameState.currentUser.username, 
                    gameState.mode, 
                    gameState.attempts
                );
                
                // æ›´æ–°UIç»Ÿè®¡
                game.updatePlayerStats(updatedUser);
                
                // æ˜¾ç¤ºèƒœåˆ©å¼¹çª—çŸ­æš‚æ—¶é—´åè‡ªåŠ¨åˆ‡æ¢åˆ°å¥–åŠ±å¼¹çª—
                elements.finalAttempts.textContent = gameState.attempts;
                utils.showModal(elements.winModal, elements.modalContent);
                
                // 2ç§’åè‡ªåŠ¨æ˜¾ç¤ºå¥–åŠ±å›¾ç‰‡
                setTimeout(() => {
                    utils.hideModal(elements.winModal, elements.modalContent);
                    game.showReward();
                }, 2000);
            },
            
            // æ¸²æŸ“ç›®æ ‡åºåˆ—
            renderTargetSequence() {
                elements.targetSequence.innerHTML = '';
                
                gameState.targetSequence.forEach(item => {
                    const element = document.createElement('div');
                    element.className = 'color-item';
                    
                    const img = document.createElement('img');
                    img.src = item.src;
                    img.alt = item.name;
                    img.className = 'color-img';
                    
                    element.appendChild(img);
                    elements.targetSequence.appendChild(element);
                });
            },
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            addToHistory() {
                const entry = document.createElement('div');
                entry.className = 'p-2 bg-gray-50 rounded-lg flex justify-between items-center';
                
                const info = document.createElement('div');
                info.innerHTML = `
                    <span class="font-medium">ç¬¬ ${gameState.attempts} æ¬¡</span>
                    <span class="text-gray-600 ml-2">æ­£ç¡®: ${gameState.correctCount}/${gameState.targetSequence.length}</span>
                `;
                
                entry.appendChild(info);
                elements.historyContainer.prepend(entry);
                
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¡è®°å½•ï¼Œç§»é™¤"æš‚æ— å†å²è®°å½•"æç¤º
                if (elements.historyContainer.querySelector('p.italic')) {
                    elements.historyContainer.innerHTML = '';
                }
                
                // é™åˆ¶å†å²è®°å½•æ˜¾ç¤ºæ•°é‡
                if (elements.historyContainer.children.length > 5) {
                    elements.historyContainer.removeChild(elements.historyContainer.lastChild);
                }
            },
            
            // æ˜¾ç¤ºå¥–åŠ±
            showReward() {
                let rewardImage, rewardText;
                const { mode, attempts } = gameState;
                
                if (mode === 'easy') {
                    if (attempts <= 15) {
                        rewardImage = gameState.images.rewards.jl;
                        rewardText = 'æ­å–œä½ åœ¨15æ¬¡å†…å®Œæˆç®€å•æ¨¡å¼ï¼';
                    } else {
                        rewardImage = gameState.images.rewards.jl2;
                        rewardText = 'ä½ å·²å®Œæˆç®€å•æ¨¡å¼';
                    }
                } else { // hard mode
                    if (attempts <= 25) {
                        rewardImage = gameState.images.rewards.jl3;
                        rewardText = 'æ­å–œä½ åœ¨25æ¬¡å†…å®Œæˆå›°éš¾æ¨¡å¼';
                    } else {
                        rewardImage = gameState.images.rewards.jl1;
                        rewardText = 'ä½ å·²å®Œæˆå›°éš¾æ¨¡å¼';
                    }
                }
                
                elements.rewardImage.src = rewardImage;
                elements.rewardImage.alt = 'æ¸¸æˆå¥–åŠ±å›¾ç‰‡';
                elements.rewardMessage.textContent = rewardText;
                
                // ç›´æ¥æ˜¾ç¤ºå¥–åŠ±å¼¹çª—
                utils.showModal(elements.rewardModal);
            },
            
            // æ›´æ–°ç©å®¶ç»Ÿè®¡
            updatePlayerStats(userData) {
                const user = userData || playerDB.getPlayer(gameState.currentUser.username);
                
                if (!user) return;
                
                // æ›´æ–°ç®€å•æ¨¡å¼ç»Ÿè®¡
                elements.easyBest.textContent = user.stats.easy.best || '-';
                elements.easyLast.textContent = user.stats.easy.last || '-';
                
                // æ›´æ–°å›°éš¾æ¨¡å¼ç»Ÿè®¡
                elements.hardBest.textContent = user.stats.hard.best || '-';
                elements.hardLast.textContent = user.stats.hard.last || '-';
                
                // æ›´æ–°æ€»ç»Ÿè®¡
                elements.totalGames.textContent = user.stats.totalGames;
                
                // æ›´æ–°å†å²è®°å½•
                elements.historyContainer.innerHTML = '';
                if (user.history.length === 0) {
                    elements.historyContainer.innerHTML = '<p class="text-gray-500 text-center italic">æš‚æ— æ¸¸æˆè®°å½•</p>';
                } else {
                    user.history.forEach(entry => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'p-2 bg-gray-50 rounded-lg';
                        
                        const modeText = entry.mode === 'easy' ? 'ç®€å•æ¨¡å¼' : 'å›°éš¾æ¨¡å¼';
                        
                        historyItem.innerHTML = `
                            <div class="flex justify-between">
                                <span class="font-medium">${modeText}</span>
                                <span class="text-sm text-gray-500">${entry.date}</span>
                            </div>
                            <div class="text-gray-600 text-sm">å°è¯•æ¬¡æ•°: ${entry.attempts}</div>
                        `;
                        
                        elements.historyContainer.appendChild(historyItem);
                    });
                }
            }
        };

        // äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // åˆ‡æ¢ç™»å½•/æ³¨å†Œè¡¨å•
            elements.loginTab.addEventListener('click', () => {
                elements.loginForm.classList.remove('hidden');
                elements.registerForm.classList.add('hidden');
                elements.loginTab.classList.add('text-primary', 'border-primary');
                elements.loginTab.classList.remove('text-gray-500', 'border-transparent');
                elements.registerTab.classList.add('text-gray-500', 'border-transparent');
                elements.registerTab.classList.remove('text-primary', 'border-primary');
            });
            
            elements.registerTab.addEventListener('click', () => {
                elements.registerForm.classList.remove('hidden');
                elements.loginForm.classList.add('hidden');
                elements.registerTab.classList.add('text-primary', 'border-primary');
                elements.registerTab.classList.remove('text-gray-500', 'border-transparent');
                elements.loginTab.classList.add('text-gray-500', 'border-transparent');
                elements.loginTab.classList.remove('text-primary', 'border-primary');
            });
            
            // æ³¨å†ŒæŒ‰é’®
            elements.registerBtn.addEventListener('click', () => {
                const username = elements.regUsername.value.trim();
                const password = elements.regPassword.value;
                const confirm = elements.regConfirm.value;
                
                if (!username || !password) {
                    utils.showError(elements.registerError, 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
                    return;
                }
                
                if (password !== confirm) {
                    utils.showError(elements.registerError, 'ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´');
                    return;
                }
                
                const result = playerDB.register(username, password);
                if (!result.success) {
                    utils.showError(elements.registerError, result.message);
                    return;
                }
                
                // æ³¨å†ŒæˆåŠŸï¼Œåˆ‡æ¢åˆ°ç™»å½•è¡¨å•
                elements.loginTab.click();
                elements.loginUsername.value = username;
                utils.showError(elements.registerError, 'æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•', 'green');
            });
            
            // ç™»å½•æŒ‰é’®
            elements.loginBtn.addEventListener('click', () => {
                const username = elements.loginUsername.value.trim();
                const password = elements.loginPassword.value;
                
                if (!username || !password) {
                    utils.showError(elements.loginError, 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
                    return;
                }
                
                const result = playerDB.login(username, password);
                if (!result.success) {
                    utils.showError(elements.loginError, result.message);
                    return;
                }
                
                // ç™»å½•æˆåŠŸ
                gameState.currentUser = {
                    username,
                    data: result.user
                };
                
                elements.welcomeUsername.textContent = username;
                elements.currentUser.textContent = username;
                
                // éšè—ç™»å½•æ¨¡æ€æ¡†ï¼Œæ˜¾ç¤ºæ¨¡å¼é€‰æ‹©
                elements.authModal.classList.add('hidden');
                elements.modeModal.classList.remove('hidden');
            });
            
            // é€‰æ‹©ç®€å•æ¨¡å¼
            elements.easyMode.addEventListener('click', () => {
                elements.modeModal.classList.add('hidden');
                elements.gameContainer.classList.remove('hidden');
                game.init('easy');
            });
            
            // é€‰æ‹©å›°éš¾æ¨¡å¼
            elements.hardMode.addEventListener('click', () => {
                elements.modeModal.classList.add('hidden');
                elements.gameContainer.classList.remove('hidden');
                game.init('hard');
            });
            
            // é‡æ–°å¼€å§‹æ¸¸æˆ
            elements.restartBtn.addEventListener('click', () => {
                game.init(gameState.mode);
            });
            
            // æ›´æ¢æ¨¡å¼
            elements.changeModeBtn.addEventListener('click', () => {
                elements.gameContainer.classList.add('hidden');
                elements.modeModal.classList.remove('hidden');
            });
            
            // æäº¤çŒœæµ‹
            elements.submitBtn.addEventListener('click', () => {
                game.submitGuess();
            });
            
            // å…³é—­å¥–åŠ±å¼¹çª—
            elements.closeReward.addEventListener('click', () => {
                utils.hideModal(elements.rewardModal);
                game.init(gameState.mode);
            });
            
            // ç™»å‡º
            elements.logoutBtn.addEventListener('click', () => {
                gameState.currentUser = null;
                elements.gameContainer.classList.add('hidden');
                elements.modeModal.classList.add('hidden');
                elements.authModal.classList.remove('hidden');
                
                // é‡ç½®è¡¨å•
                elements.loginUsername.value = '';
                elements.loginPassword.value = '';
                elements.regUsername.value = '';
                elements.regPassword.value = '';
                elements.regConfirm.value = '';
                elements.loginTab.click();
            });
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            playerDB.init();
            setupEventListeners();
        }

        // å¯åŠ¨åº”ç”¨
        initApp();
    </script>
</body>
</html>
